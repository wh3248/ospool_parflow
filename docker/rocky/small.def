Bootstrap: docker
From: docker.io/rockylinux/rockylinux:9

%environment
    export DEBIAN_FRONTEND=noninteractive
    export BASE_PATH=./parflow_build
    export CMAKE=$BASE_PATH/parflow/dependencies/cmake/bin/cmake
    export CTEST=$BASE_PATH/parflow/dependencies/cmake/bin/ctest
    export HDF5_DIR=$BASE_PATH/hdf5
    export NETCDF_DIR=$BASE_PATH/netcdf
    export HYPRE_DIR=/$BASE_PATH/hypre
    export PARFLOW_DIR=$BASE_PATH/parflow/
    export LD_LIBRARY_PATH=$PARFLOW_DIR/lib:$HYPRE_DIR/lib:/usr/include/:$LD_LIBRARY_PATH


%post
    # Fetch the latest definitions of packages

    dnf -y update

    dnf -y install \
        epel-release \
        gcc \
        gcc-c++ \
        gcc-gfortran \
        make \
        which \
        python3 \
        python3-pip \
        git \
        tcl \
        tk \
   
    dnf clean all

    ln -s /usr/bin/python3 /usr/bin/python

    # Create directories
    mkdir -p \
        $BASE_PATH/parflow/build \
        $BASE_PATH/parflow/dependencies/cmake \
        $BASE_PATH/parflow/dependencies/silo-src \
        $BASE_PATH/parflow/dependencies/hdf5-src \
        $BASE_PATH/parflow/dependencies/hypre-src \
        $BASE_PATH/parflow/dependencies/netcdf-src

    # Install CMake
    cd $BASE_PATH/parflow/dependencies/cmake
    curl -L https://github.com/Kitware/CMake/releases/download/v3.29.0/cmake-3.29.0-linux-x86_64.tar.gz | tar --strip-components=1 -xzv

    # Install HDF5    