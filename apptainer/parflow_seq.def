
Bootstrap: docker
From: docker.io/rockylinux/rockylinux:10

%environment
    export DEBIAN_FRONTEND=noninteractive
    export BASE_PATH=/opt/tools
    export CMAKE_DIR=$BASE_PATH/cmake
    export HYPRE_DIR=$BASE_PATH/hypre
    export PARFLOW_DIR=$BASE_PATH/parflow
    export LD_LIBRARY_PATH=$PARFLOW_DIR/lib:$HYPRE_DIR/lib:/usr/include/:$LD_LIBRARY_PATH
    export PATH=$CMAKE_DIR/bin:$PATH

%post
    export BASE_PATH=/opt/tools
    export CMAKE_DIR=$BASE_PATH/cmake
    export HYPRE_DIR=$BASE_PATH/hypre
    export PARFLOW_DIR=$BASE_PATH/parflow
    export LD_LIBRARY_PATH=$PARFLOW_DIR/lib:$HYPRE_DIR/lib:/usr/include/:$LD_LIBRARY_PATH
    export PATH=$CMAKE_DIR/bin:$PATH
 
    dnf -y update
    dnf -y install tcl-devel tk-devel
    dnf -y install which

    dnf -y groupinstall "Development Tools"
    dnf -y install dnf-plugins-core
    dnf -y install openssh-clients
    dnf -y install git
    dnf -y install gfortran
    dnf -y install libffi-devel
    dnf -y install openssl-devel
    dnf clean all

    ln -s /usr/bin/python3.12 /usr/bin/python
    python -m ensurepip --upgrade
    python -m pip install --upgrade pip

    # Install CMake
    mkdir -p $CMAKE_DIR
    cd $CMAKE_DIR
    curl -L https://github.com/Kitware/CMake/releases/download/v3.30.8/cmake-3.30.8-linux-x86_64.tar.gz | tar --strip-components=1 -xzv
    

    # Install Hypre
    mkdir -p $HYPRE_DIR
    cd $HYPRE_DIR
    curl -L https://github.com/hypre-space/hypre/archive/v2.17.0.tar.gz | tar --strip-components=1 -xzv && \
    cd src && ./configure --prefix=$HYPRE_DIR --without-MPI && \
    make install

    cd $BASE_PATH
    git clone https://github.com/parflow/parflow.git
    cd parflow/
    mkdir build
    cd build/
    cmake .. \
        -DCMAKE_C_FLAGS="-Wno-int-conversion" \
        -DCMAKE_INSTALL_PREFIX=$PARFLOW_DIR             \
        -DHYPRE_ROOT=$HYPRE_DIR                         \
        -DHYPRE_DIR=$HYPRE_DIR                         \
        -DPARFLOW_ENABLE_PYTHON=TRUE                    \
        -DPARFLOW_HAVE_CLM=TRUE                         \
        -DCMAKE_BUILD_TYPE=Release                      \
        -DPARFLOW_AMPS_LAYER=seq                       \
        -DPARFLOW_AMPS_SEQUENTIAL_IO=ON                 \
        -DPARFLOW_ENABLE_HYPRE=ON                       \
        -DPARFLOW_ENABLE_SIMULATOR=ON                   \
        -DPARFLOW_ENABLE_SZLIB=ON                       \
        -DPARFLOW_ENABLE_TOOLS=ON                       \
        -DPARFLOW_ENABLE_ZLIB=ON

    make
    make install
    rm -rf $PARFLOW_DIR/.git

    python -m pip install subsettools

